<script>
(function(){
  // ===== CONFIG =====
  // Use your webhook URL
  const WEBHOOK_URL = "https://n8n.norkx.space/webhook/inv-sys.2.01";

  // DOM handles (scoped)
  const root = document.getElementById('softrCustomUpload_v1');
  const form = root.querySelector('#uploadForm');
  const nextButton = root.querySelector('#nextButton');
  const blackout = root.querySelector('#blackout');

  const fileNameInput = root.querySelector('#fileName');
  const fileLinkInput = root.querySelector('#fileLink');
  const trackIdInput = root.querySelector('#trackId');
  const projectNameInput = root.querySelector('#projectName');
  const clientNameInput = root.querySelector('#clientName');

  const fileNameError = root.querySelector('#fileNameError');
  const fileLinkError = root.querySelector('#fileLinkError');

  // ===== Helpers to extract Softr info (non-destructive) =====
  function getTrackIdFromSoftr(){
    try {
      const el = document.querySelector('[data-softr-field-id="_nnusgnxxr"] p') || document.querySelector('[data-softr-field-id="_nnusgnxxr"]');
      if (el && el.textContent && el.textContent.trim()) return el.textContent.trim();
    } catch(e){}
    return '';
  }

  function getProjectNameFromSoftr(){
    try {
      const el = document.querySelector('[data-softr-field-id="_vjtxepvw6"] p') || document.querySelector('[data-softr-field-id="_vjtxepvw6"]');
      if (el && el.textContent && el.textContent.trim()) return el.textContent.trim();
    } catch(e){}
    return '';
  }

  function getClientNameFromSoftr(){
    try {
      const el = document.querySelector('[data-softr-field-id="_t6inl8epd"] p') || document.querySelector('[data-softr-field-id="_t6inl8epd"]');
      if (el && el.textContent && el.textContent.trim()) return el.textContent.trim();
    } catch(e){}
    return '';
  }

  function getSoftrUserEmail(){
    try {
      const w = window;
      if (w.logged_in_user?.softr_user_email) return w.logged_in_user.softr_user_email;
      if (w.Softr?.currentUser?.email) return w.Softr.currentUser.email;
      if (w.loggedInUser?.email) return w.loggedInUser.email;
      const ph = document.getElementById('softrUserEmailPlaceholder');
      if (ph && ph.textContent && ph.textContent.trim()) return ph.textContent.trim();
      const tokenEl = document.querySelector('[data-logged-in-email]') || document.querySelector('span[data-softr-user-email]');
      if (tokenEl && tokenEl.textContent && tokenEl.textContent.trim()) return tokenEl.textContent.trim();
      const bodyText = document.body ? document.body.innerText : '';
      const match = bodyText && bodyText.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
      if (match) return match[0];
    } catch(e){}
    return "unknown@user.com";
  }

  // Initialize hidden fields on load if possible
  window.addEventListener('load', () => {
    try {
      const tid = getTrackIdFromSoftr();
      if (tid) trackIdInput.value = tid;
      const pname = getProjectNameFromSoftr();
      if (pname) projectNameInput.value = pname;
      const cname = getClientNameFromSoftr();
      if (cname) clientNameInput.value = cname;
    } catch(e){}
  });

  // Clear inline errors when the user types
  [fileNameInput, fileLinkInput].forEach(i => {
    i.addEventListener('input', () => {
      i.classList.remove('error-border');
      const err = root.querySelector('#' + i.id + 'Error');
      if (err) err.style.display = 'none';
      blackout.classList.remove('visible');
      blackout.innerHTML = '';
    });
  });

  // Escape HTML for safe insertion
  function escapeHtml(s) {
    return String(s).replace(/[&<>"'`=\/]/g, function (c) {
      return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;', '/':'&#x2F;','`':'&#x60;','=':'&#x3D;' })[c];
    });
  }

  function showBlackout(message, allowTryAgain=false) {
    blackout.innerHTML = '<div>' + escapeHtml(message) + '</div>';
    if (allowTryAgain) {
      const btn = document.createElement('button');
      btn.className = 'try-again-btn';
      btn.type = 'button';
      btn.textContent = 'Try Again';
      btn.addEventListener('click', () => {
        blackout.classList.remove('visible');
        blackout.innerHTML = '';
        fileLinkInput.focus();
      });
      blackout.appendChild(btn);
    }
    blackout.classList.add('visible');
  }

  function validate() {
    let ok = true;
    if (!fileNameInput.value.trim()) {
      fileNameInput.classList.add('error-border');
      fileNameError.style.display = 'block';
      ok = false;
    } else {
      fileNameInput.classList.remove('error-border');
      fileNameError.style.display = 'none';
    }
    if (!fileLinkInput.value.trim()) {
      fileLinkInput.classList.add('error-border');
      fileLinkError.style.display = 'block';
      ok = false;
    } else {
      fileLinkInput.classList.remove('error-border');
      fileLinkError.style.display = 'none';
    }
    return ok;
  }

  // Main submit handler
  form.addEventListener('submit', async function(e){
    e.preventDefault();

    if (!validate()) return;

    const original = nextButton.innerHTML;
    nextButton.innerHTML = '<div class="spinner" aria-hidden="true"></div>';
    nextButton.classList.add('loading');

    const payload = {
      fileName: fileNameInput.value.trim(),
      fileLink: fileLinkInput.value.trim(),
      userEmail: getSoftrUserEmail(),
      trackId: trackIdInput.value.trim() || getTrackIdFromSoftr(),
      projectName: projectNameInput.value.trim() || getProjectNameFromSoftr(),
      clientName: clientNameInput.value.trim() || getClientNameFromSoftr()
    };

    try {
      // ===========================
      // **KEY CHANGE**: Remove custom headers
      // ===========================
      const resp = await fetch(WEBHOOK_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      let messageForUI = '';
      let jsonForLogic = null;
      try {
        const ct = (resp.headers.get('content-type') || '').toLowerCase();
        if (ct.includes('application/json')) {
          jsonForLogic = await resp.json();
          messageForUI = (jsonForLogic && (jsonForLogic.message || jsonForLogic.error)) || JSON.stringify(jsonForLogic);
        } else {
          const txt = await resp.text();
          messageForUI = (txt && txt.trim()) ? txt.trim() : `Webhook returned status ${resp.status}`;
        }
      } catch(parseErr) {
        try { const fallback = await resp.text(); messageForUI = fallback || 'Invalid response from server'; }
        catch(e) { messageForUI = 'Invalid response from server'; }
      }

      nextButton.innerHTML = original;
      nextButton.classList.remove('loading');

      const duplicateRegex = /Your file link is already associated with your Project\s+([^.]*)\./i;
      const isDuplicate = (typeof messageForUI === 'string') && duplicateRegex.test(messageForUI);

      showBlackout(messageForUI, isDuplicate);

      if (jsonForLogic && (jsonForLogic.success === true || jsonForLogic.exists === false)) {
        try { form.reset(); } catch(_) {}
      }

    } catch(err) {
      nextButton.innerHTML = original;
      nextButton.classList.remove('loading');
      showBlackout('Network error â€” could not reach server.', false);
    }
  });
})();
</script>
